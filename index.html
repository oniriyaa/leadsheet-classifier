<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Leadsheet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #5e72e4;
            box-shadow: 0 5px 15px rgba(94, 114, 228, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(94, 114, 228, 0.3);
        }

        .sample-format {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .sample-format h3 {
            color: #5e72e4;
            margin-bottom: 10px;
        }

        .sample-format pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #11cdef 0%, #1171ef 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(17, 205, 239, 0.3);
        }

        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            margin-top: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        thead {
            background: linear-gradient(135deg, #5e72e4 0%, #825ee4 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .editable-cell {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .editable-cell:hover {
            background-color: #e8f4fd;
        }

        .editable-cell.editing {
            padding: 0;
        }

        .cell-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #5e72e4;
            background: white;
            font-size: inherit;
            font-family: inherit;
            outline: none;
        }

        .cell-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #5e72e4;
            background: white;
            font-size: inherit;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        .edit-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8rem;
            color: #5e72e4;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .editable-cell:hover .edit-indicator {
            opacity: 1;
        }

        .modified-row {
            background-color: #fff3cd !important;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .edit-btn, .save-btn, .cancel-btn, .delete-row-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .edit-btn {
            background: #17a2b8;
            color: white;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .delete-row-btn {
            background: #dc3545;
            color: white;
        }

        .edit-btn:hover, .save-btn:hover, .cancel-btn:hover, .delete-row-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .bulk-edit-controls {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-edit-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .enable-edit-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .save-all-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .cancel-all-btn {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
        }

        .undo-btn {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: white;
        }

        .bulk-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .bulk-edit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .edit-status {
            padding: 8px 15px;
            background: #d1ecf1;
            color: #0c5460;
            border-radius: 8px;
            font-weight: 500;
        }

        .changes-counter {
            padding: 8px 15px;
            background: #fff3cd;
            color: #856404;
            border-radius: 8px;
            font-weight: 500;
        }

        .download-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #2dce89 0%, #11cdef 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-top: 20px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(45, 206, 137, 0.3);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h4 {
            color: #5e72e4;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        .custom-mapping-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            border-radius: 15px;
            color: white;
        }

        .custom-mapping-section h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mapping-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .save-mapping-btn, .load-mapping-btn, .export-mapping-btn, .clear-mapping-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .save-mapping-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .load-mapping-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .export-mapping-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .clear-mapping-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .save-mapping-btn:hover, .load-mapping-btn:hover, 
        .export-mapping-btn:hover, .clear-mapping-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .saved-mappings-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .mapping-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mapping-item-info {
            flex: 1;
        }

        .mapping-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .mapping-item-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .mapping-item-actions {
            display: flex;
            gap: 8px;
        }

        .mapping-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .mapping-load-btn {
            background: #28a745;
            color: white;
        }

        .mapping-delete-btn {
            background: #dc3545;
            color: white;
        }

        .mapping-action-btn:hover {
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            margin: 0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 10px;
            transition: border-color 0.3s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: #5e72e4;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-save-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-cancel-btn {
            background: #6c757d;
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .import-mapping-input {
            display: none;
        }

        .ai-copilot-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .ai-copilot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ai-copilot-title {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-classify-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-classify-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
        }

        .auto-classify-btn.processing {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            animation: pulse 1s infinite;
        }

        .copilot-status {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .status-label {
            font-weight: 600;
        }

        .status-value {
            font-weight: bold;
            color: #11cdef;
        }

        .toggle-table-btn {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .toggle-table-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .table-container {
            transition: all 0.5s ease;
            overflow: hidden;
        }

        .table-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .table-container.expanded {
            max-height: none;
            opacity: 1;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11cdef 0%, #1171ef 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .ai-helper-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
        }

        .ai-helper-section h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unclassified-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .unclassified-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-suggest-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .ai-suggest-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(240, 147, 251, 0.3);
        }

        .ai-suggest-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .ai-suggestion-result {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .suggestion-item {
            display: grid;
            grid-template-columns: 2fr 2fr 2fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .suggestion-editable {
            padding: 5px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggestion-editable:hover {
            background: #e8f4fd;
            border-color: #5e72e4;
        }

        .suggestion-editable.editing {
            background: white;
            border-color: #5e72e4;
            border-width: 2px;
        }

        .refresh-data-btn {
            background: linear-gradient(135deg, #00d2ff 0%, #3a47d5 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-data-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(58, 71, 213, 0.3);
        }

        .refresh-data-btn.spinning {
            animation: pulse 1s infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.5s ease;
        }

        .refresh-data-btn:hover .refresh-icon {
            transform: rotate(180deg);
        }

        .ai-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .preview-changes-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .preview-changes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3);
        }

        .changes-preview {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .change-item {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 2fr;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            align-items: center;
        }

        .change-item:last-child {
            border-bottom: none;
        }

        .old-value {
            color: #dc3545;
            text-decoration: line-through;
        }

        .new-value {
            color: #28a745;
            font-weight: 600;
        }

        .apply-suggestions-btn {
            background: linear-gradient(135deg, #11cdef 0%, #1171ef 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            width: 100%;
        }

        .apply-selected-btn {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }

        .select-all-btn {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .apply-suggestions-btn:hover, .apply-selected-btn:hover, .select-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(17, 205, 239, 0.3);
        }

        .manual-classification {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .manual-classification h4 {
            margin-bottom: 10px;
        }

        .classification-form {
            display: grid;
            gap: 10px;
        }

        .form-group {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
            align-items: center;
        }

        .form-group label {
            font-weight: 600;
        }

        .form-group select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading {
            animation: pulse 1s infinite;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Leadsheet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á</h1>
            <p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô Leadsheet ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2>üìÅ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
                <p style="margin: 10px 0; color: #666;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV, Excel (.xlsx, .xls) ‡∏´‡∏£‡∏∑‡∏≠ Text file</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.txt">
                    <label for="fileInput" class="file-input-label">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    </label>
                    <!-- Custom Mapping Section -->
                <div class="custom-mapping-section">
                    <h3>
                        <span>üíæ</span>
                        <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Mapping ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</span>
                    </h3>
                    
                    <div class="mapping-controls">
                        <button onclick="saveCurrentMapping()" class="save-mapping-btn">
                            <span>üíæ</span>
                            <span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Mapping ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                        </button>
                        <button onclick="document.getElementById('importMappingInput').click()" class="load-mapping-btn">
                            <span>üìÇ</span>
                            <span>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Mapping</span>
                        </button>
                        <input type="file" id="importMappingInput" class="import-mapping-input" accept=".json" onchange="importMapping(event)">
                        <button onclick="exportAllMappings()" class="export-mapping-btn">
                            <span>üì§</span>
                            <span>‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </button>
                        <button onclick="clearAllMappings()" class="clear-mapping-btn">
                            <span>üóëÔ∏è</span>
                            <span>‡∏•‡πâ‡∏≤‡∏á Mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </button>
                    </div>
                    
                    <div class="saved-mappings-list" id="savedMappingsList">
                        <p style="opacity: 0.9;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Mapping ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
                    </div>
                </div>
            </div>

            <!-- Save Mapping Modal -->
            <div id="saveMappingModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Mapping</h2>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="mappingNameInput" class="modal-input" 
                               placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Mapping (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC, ‡∏á‡∏ö Q1 2024)">
                        <textarea id="mappingDescInput" class="modal-input" rows="3" 
                                  placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button onclick="closeSaveModal()" class="modal-btn modal-cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="confirmSaveMapping()" class="modal-btn modal-save-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>

                <div class="sample-format">
                    <h3>üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:</h3>
                    <pre>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ,‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ,‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï,‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
1101,‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î,50000,0
1102,‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£,100000,0
2101,‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤,0,75000

‡∏´‡∏£‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ,‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï,‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï
‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î,50000,0
‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£,100000,0
‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤,0,75000</pre>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        * ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ<br>
                        * ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                    </p>
                </div>

                <button id="processBtn" class="process-btn" disabled>
                    üîÑ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
                </button>
            </div>

            <div id="resultsSection" class="results-section">
                <h2 style="margin-bottom: 20px;">üìà ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Leadsheet</h2>
                
                <div class="stats-cards" id="statsCards"></div>

                <!-- AI Copilot Section -->
                <div class="ai-copilot-section">
                    <div class="ai-copilot-header">
                        <div class="ai-copilot-title">
                            <span>ü§ñ</span>
                            <span>AI Copilot - ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                        </div>
                        <button id="autoClassifyBtn" onclick="autoClassifyAll()" class="auto-classify-btn">
                            <span>‚ú®</span>
                            <span>‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                        </button>
                    </div>
                    
                    <div class="copilot-status">
                        <div class="status-item">
                            <span class="status-label">üìä ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <span class="status-value" id="totalAccountsStatus">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß:</span>
                            <span class="status-value" id="classifiedStatus">0</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°:</span>
                            <span class="status-value" id="unclassifiedStatus">0</span>
                        </div>
                    </div>
                    
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div style="margin: 20px 0;">
                    <button onclick="toggleTable()" class="toggle-table-btn">
                        <span id="toggleIcon">üëÅÔ∏è</span>
                        <span id="toggleText">‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
                    </button>
                    <button onclick="downloadCSV()" class="download-btn">
                        üíæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV
                    </button>
                    <button onclick="downloadExcel()" class="download-btn" style="background: linear-gradient(135deg, #f5365c 0%, #f56036 100%);">
                        üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel
                    </button>
                    <button onclick="forceRefreshTable()" class="refresh-data-btn">
                        <span class="refresh-icon">üîÑ</span> 
                        <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
                    </button>
                </div>

                <!-- Bulk Edit Controls -->
                <div class="bulk-edit-controls" id="bulkEditControls">
                    <button id="enableEditBtn" onclick="toggleEditMode()" class="bulk-edit-btn enable-edit-btn">
                        ‚úèÔ∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button id="saveAllBtn" onclick="saveAllChanges()" class="bulk-edit-btn save-all-btn" style="display: none;">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    <button id="cancelAllBtn" onclick="cancelAllChanges()" class="bulk-edit-btn cancel-all-btn" style="display: none;">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                    <button id="undoBtn" onclick="undoLastChange()" class="bulk-edit-btn undo-btn" style="display: none;">
                        ‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                    <span id="editStatus" class="edit-status" style="display: none;">
                        üìù ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏¥‡∏î
                    </span>
                    <span id="changesCounter" class="changes-counter" style="display: none;">
                        ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </span>
                </div>

                <div class="table-container expanded" id="tableContainer">
                    <div style="overflow-x: auto;">
                        <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
                                    <th>Leadsheet Group</th>
                                    <th>LS Sub Group Name</th>
                                    <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï</th>
                                    <th>‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- AI Helper Section -->
                <div id="aiHelperSection" class="ai-helper-section" style="display: none;">
                    <h3>
                        <span>ü§ñ</span>
                        <span>AI Assistant - ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ</span>
                    </h3>
                    
                    <div id="unclassifiedList" class="unclassified-list"></div>
                    
                    <button id="aiSuggestBtn" class="ai-suggest-btn" onclick="getAISuggestions()">
                        <span>‚ú®</span>
                        <span>‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</span>
                    </button>
                    
                    <div id="aiSuggestionResult" class="ai-suggestion-result" style="display: none;"></div>

                    <!-- Manual Classification -->
                    <div class="manual-classification">
                        <h4>üìù ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h4>
                        <div class="classification-form">
                            <div class="form-group">
                                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</label>
                                <select id="manualAccountSelect">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Leadsheet Group:</label>
                                <select id="manualGroupSelect" onchange="updateSubGroupOptions()">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sub Group:</label>
                                <select id="manualSubGroupSelect">
                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>
                                </select>
                            </div>
                            <button onclick="applyManualClassification()" class="apply-suggestions-btn">
                                ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Account code generation mapping
        const accountCodeMapping = {
            // ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (1000s)
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î': '1101',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô': '1102',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå': '1103',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥': '1104',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£': '1201',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏Å‡πÄ‡∏á‡∏¥‡∏ô': '1202',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô': '1203',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤': '1204',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô)': '1205',
            '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': '1301',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç - ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': '1302',
            '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô': '1303',
            '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö': '1401',
            '‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥': '1402',
            '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ': '1403',
            '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': '1404',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': '1405',
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤': '1501',
            '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': '1599',
            '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô': '1601',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∞‡∏™‡∏°': '1602',
            '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô': '1701',
            '‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°': '1702',
            
            // ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (2000s)
            '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': '2101',
            '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô': '2102',
            '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': '2201',
            '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô': '2202',
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢': '2301',
            '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢': '2302',
            '‡∏†‡∏≤‡∏©‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢': '2303',
            '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ': '2399',
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô': '2401',
            '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô': '2501',
            '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': '2601',
            
            // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô (3000s)
            '‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç': '3101',
            '‡∏´‡∏∏‡πâ‡∏ô‡∏ö‡∏∏‡∏£‡∏¥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥': '3102',
            '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç': '3201',
            '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏ö‡∏∏‡∏£‡∏¥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥': '3202',
            '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢': '3301',
            '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': '3302',
            '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£': '3401',
            
            // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (4000s)
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '4101',
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '4102',
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '4201',
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '4202',
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô': '4901',
            '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å': '4902',
            '‡∏Å‡∏≥‡πÑ‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô': '4903',
            
            // ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (5000s)
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '5101',
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': '5102',
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ñ‡πà‡∏≤‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå': '5201',
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢': '5202',
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': '5203',
            '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤': '5301',
            '‡πÇ‡∏ö‡∏ô‡∏±‡∏™': '5302',
            '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô': '5303',
            '‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£': '5304',
            '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢': '5401',
            '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≤‡∏¢': '5402',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡∏π‡∏á‡∏≤‡∏ô': '5403',
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': '5499',
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': '5501',
            '‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ': '5502',
            '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': '5503',
            '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°': '5504',
            '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°': '5505',
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô': '5599',
            '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô': '5601',
            '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏ä‡πà‡∏≤‡∏ã‡∏∑‡πâ‡∏≠': '5602',
            '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß': '5603',
            '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô': '5701',
            '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': '5702'
        };

        // Counter for generating unique codes - Initialize properly
        let codeCounters = {
            '1': 1800, // ‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            '2': 2700, // ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            '3': 3500, // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            '4': 4500, // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            '5': 5800, // ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            '9': 9000  // ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
        };

        // Leadsheet mapping database
        const leadsheetMappings = {
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£': {
                keywords: ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å', '‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£', 'cash', 'bank', 'deposit'],
                defaultCode: '1100',
                subGroups: {
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î': ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏¢‡πà‡∏≠‡∏¢', 'cash on hand', 'petty cash'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô': ['‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', 'current account', 'checking'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå': ['‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', 'saving', 'savings account'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥': ['‡∏õ‡∏£‡∏∞‡∏à‡∏≥', 'fixed deposit', 'time deposit']
                }
            },
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô': {
                keywords: ['‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô', '‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£', '‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', 'investment', 'securities'],
                subGroups: {
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£': ['‡∏û‡∏±‡∏ô‡∏ò‡∏ö‡∏±‡∏ï‡∏£', 'bond', 'government bond'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏Å‡πÄ‡∏á‡∏¥‡∏ô': ['‡∏ï‡∏±‡πã‡∏ß‡πÅ‡∏•‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', 'bill of exchange', 'promissory note'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô': ['‡∏ù‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥', '‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤': ['‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏≤', 'trading securities'],
                    '‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô)': ['‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢', 'available for sale']
                }
            },
            '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': {
                keywords: ['‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ', 'receivable', 'debtor', '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢'],
                subGroups: {
                    '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': ['‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', 'trade receivable', 'account receivable'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç - ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢', 'allowance', 'bad debt'],
                    '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô': ['‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô', 'other receivable']
                }
            },
            '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': {
                keywords: ['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', 'inventory', 'stock', '‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥'],
                subGroups: {
                    '‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö': ['‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö', 'raw material'],
                    '‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥': ['‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≥', 'work in process', 'WIP'],
                    '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ': ['‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ', 'finished goods'],
                    '‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': ['‡∏ß‡∏±‡∏™‡∏î‡∏∏', 'supplies', 'material'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠': ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏î‡∏•‡∏á', 'allowance inventory']
                }
            },
            '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': {
                keywords: ['‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', 'property', 'plant', 'equipment', 'PPE'],
                subGroups: {
                    '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå - ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô': ['‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£', '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∞‡∏™‡∏°': ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤', 'accumulated depreciation'],
                    '‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏¢‡∏∏‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': ['‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤', 'revaluation'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå': ['‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏≤', 'impairment']
                }
            },
            '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': {
                keywords: ['‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ', 'payable', 'creditor'],
                subGroups: {
                    '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': ['‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', 'trade payable', 'account payable'],
                    '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô': ['‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô', 'other payable']
                }
            },
            '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô': {
                keywords: ['‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ', '‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'loan', 'overdraft', '‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô'],
                subGroups: {
                    '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': ['‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'overdraft', 'OD'],
                    '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô': ['‡∏ï‡∏±‡πã‡∏ß‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô', 'promissory note', 'P/N']
                }
            },
            '‡∏ó‡∏∏‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß': {
                keywords: ['‡∏ó‡∏∏‡∏ô', '‡∏´‡∏∏‡πâ‡∏ô', 'capital', 'share', 'stock'],
                subGroups: {
                    '‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç': ['‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç', 'common stock', 'ordinary share'],
                    '‡∏´‡∏∏‡πâ‡∏ô‡∏ö‡∏∏‡∏£‡∏¥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥': ['‡∏´‡∏∏‡πâ‡∏ô‡∏ö‡∏∏‡∏£‡∏¥‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', 'preferred stock', 'preference share']
                }
            },
            '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° - ‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÅ‡∏•‡πâ‡∏ß': {
                keywords: ['‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'reserve', 'appropriated'],
                subGroups: {
                    '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢': ['‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢', 'legal reserve'],
                    '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': ['‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô', 'other reserve']
                }
            },
            '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£': {
                keywords: ['‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°', 'retained earnings', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£'],
                subGroups: {
                    '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£': ['‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏°', 'retained earnings', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£', 'unappropriated']
                }
            },
            '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢': {
                keywords: ['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ', '‡∏Ç‡∏≤‡∏¢', 'revenue', 'sales', 'income'],
                subGroups: {
                    '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': ['‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', 'domestic sales', 'local sales'],
                    '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': ['‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', 'export', 'foreign sales']
                }
            },
            '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢': {
                keywords: ['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢', 'cost of goods sold', 'COGS', 'cost of sales'],
                subGroups: {
                    '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': ['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', 'domestic COGS'],
                    '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': ['‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', 'export COGS']
                }
            },
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢': {
                keywords: ['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢', 'selling expense', '‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'marketing'],
                subGroups: {
                    '‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢': ['‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'promotion', 'advertising'],
                    '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ç‡∏≤‡∏¢': ['‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢', 'sales welfare'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡∏π‡∏á‡∏≤‡∏ô': ['‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', 'travel', 'business trip'],
                    '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ': ['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô', 'other selling expense']
                }
            },
            '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£': {
                keywords: ['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', 'administrative', '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'office'],
                subGroups: {
                    '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': ['‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'office expense'],
                    '‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ': ['‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ', 'utilities', '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', '‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤'],
                    '‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤ - ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô': ['‡πÄ‡∏™‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'office depreciation'],
                    '‡∏Ñ‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°': ['‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°', 'repair', 'maintenance'],
                    '‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°': ['‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', 'fee', 'charge'],
                    '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô': ['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô', 'other expense']
                }
            },
            '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ': {
                keywords: ['‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ', 'income tax', 'tax expense'],
                subGroups: {
                    '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô': ['‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', 'current tax'],
                    '‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ': ['‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏≠‡∏ï‡∏±‡∏î', 'deferred tax']
                }
            }
        };

        let uploadedData = [];
        let processedData = [];
        let originalData = [];
        let unclassifiedAccounts = [];
        let aiSuggestions = {};
        let customMappings = {};
        let savedMappings = [];
        let editMode = false;
        let modifiedRows = new Set();
        let changeHistory = [];
        let tableVisible = true;

        // Load saved mappings from localStorage on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadSavedMappings();
        });

        function toggleTable() {
            const tableContainer = document.getElementById('tableContainer');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');
            
            tableVisible = !tableVisible;
            
            if (tableVisible) {
                tableContainer.classList.remove('collapsed');
                tableContainer.classList.add('expanded');
                toggleIcon.textContent = 'üëÅÔ∏è';
                toggleText.textContent = '‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
            } else {
                tableContainer.classList.add('collapsed');
                tableContainer.classList.remove('expanded');
                toggleIcon.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleText.textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á';
            }
        }

        function autoClassifyAll() {
            const btn = document.getElementById('autoClassifyBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            // Show processing state
            btn.classList.add('processing');
            btn.innerHTML = '<span>‚è≥</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>';
            btn.disabled = true;
            progressBar.style.display = 'block';
            
            let classified = 0;
            let total = processedData.length;
            let updates = 0;
            
            // Process each item
            processedData.forEach((item, index) => {
                // Skip if already classified properly
                if (item.leadsheetGroup !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && item.subGroup !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    classified++;
                    return;
                }
                
                // Try to classify using AI logic
                const name = item.accountName.toLowerCase();
                const code = item.accountCode;
                let newGroup = item.leadsheetGroup;
                let newSubGroup = item.subGroup;
                
                // Enhanced AI classification logic
                if (name.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') || name.includes('cash')) {
                    newGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
                    newSubGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
                } else if (name.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å') || name.includes('‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£')) {
                    newGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£';
                    newSubGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏≠‡∏≠‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå';
                } else if (name.includes('‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ')) {
                    newGroup = '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤';
                    newSubGroup = '‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤';
                } else if (name.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ')) {
                    newGroup = '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤';
                    newSubGroup = '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤';
                } else if (name.includes('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') || name.includes('inventory')) {
                    newGroup = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
                    newSubGroup = '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ';
                } else if (name.includes('‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô') || name.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢')) {
                    newGroup = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                    newSubGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤';
                } else if (name.includes('‡∏†‡∏≤‡∏©‡∏µ')) {
                    if (name.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') || name.includes('‡∏Ç‡∏≤‡∏¢')) {
                        newGroup = '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                        newSubGroup = '‡∏†‡∏≤‡∏©‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢';
                    } else {
                        newGroup = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                        newSubGroup = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
                    }
                } else if (name.includes('‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥') || name.includes('‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü') || name.includes('‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ')) {
                    newGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                    newSubGroup = '‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ';
                } else if (name.includes('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') || name.includes('‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á')) {
                    newGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
                    newSubGroup = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
                } else if (name.includes('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤')) {
                    newGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                    newSubGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
                } else if (name.includes('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢')) {
                    if (item.debit > 0) {
                        newGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô';
                        newSubGroup = '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô';
                    } else {
                        newGroup = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô';
                        newSubGroup = '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å';
                    }
                } else if (name.includes('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')) {
                    newGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';
                    newSubGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
                } else if (name.includes('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ')) {
                    newGroup = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô';
                    newSubGroup = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô';
                } else if (name.includes('‡∏ó‡∏∏‡∏ô') || name.includes('‡∏´‡∏∏‡πâ‡∏ô')) {
                    newGroup = '‡∏ó‡∏∏‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
                    newSubGroup = '‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç';
                } else if (name.includes('‡∏Å‡∏≥‡πÑ‡∏£')) {
                    newGroup = '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∞‡∏™‡∏° - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£';
                    newSubGroup = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£';
                } else {
                    // Use code pattern if name doesn't match
                    if (code.startsWith('1') || code.startsWith('99')) {
                        newGroup = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                        newSubGroup = '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ';
                    } else if (code.startsWith('2')) {
                        newGroup = '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô';
                        newSubGroup = '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                    } else if (code.startsWith('3')) {
                        newGroup = '‡∏ó‡∏∏‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
                        newSubGroup = '‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç';
                    } else if (code.startsWith('4')) {
                        newGroup = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô';
                        newSubGroup = '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô';
                    } else if (code.startsWith('5')) {
                        newGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£';
                        newSubGroup = '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô';
                    }
                }
                
                // Update if changed
                if (newGroup !== item.leadsheetGroup || newSubGroup !== item.subGroup) {
                    processedData[index].leadsheetGroup = newGroup;
                    processedData[index].subGroup = newSubGroup;
                    updates++;
                    
                    // Save to custom mappings
                    const accountName = item.accountName.toLowerCase();
                    customMappings[accountName] = {
                        leadsheetGroup: newGroup,
                        subGroup: newSubGroup
                    };
                }
                
                classified++;
                
                // Update progress
                const progress = Math.round((classified / total) * 100);
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
            });
            
            // Complete processing
            setTimeout(() => {
                // Update unclassified list
                unclassifiedAccounts = [];
                processedData.forEach(item => {
                    if (item.leadsheetGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' || item.subGroup === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                        unclassifiedAccounts.push(item);
                    }
                });
                
                // Refresh display
                displayResults();
                
                // Reset button
                btn.classList.remove('processing');
                btn.innerHTML = '<span>‚ú®</span><span>‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>';
                btn.disabled = false;
                
                // Hide progress after 2 seconds
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 2000);
                
                // Show success message
                showMessage(`‚úÖ AI Copilot ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ${updates} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏ö ${classified} ‡∏à‡∏≤‡∏Å ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'success');
            }, 1500);
        }

        function updateCopilotStatus() {
            const totalAccounts = processedData.length;
            const classifiedAccounts = processedData.filter(item => 
                item.leadsheetGroup !== '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && item.subGroup !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            ).length;
            const unclassifiedCount = totalAccounts - classifiedAccounts;
            
            document.getElementById('totalAccountsStatus').textContent = totalAccounts;
            document.getElementById('classifiedStatus').textContent = classifiedAccounts;
            document.getElementById('unclassifiedStatus').textContent = unclassifiedCount;
        }

        function toggleEditMode() {
            editMode = !editMode;
            const enableBtn = document.getElementById('enableEditBtn');
            const saveBtn = document.getElementById('saveAllBtn');
            const cancelBtn = document.getElementById('cancelAllBtn');
            const undoBtn = document.getElementById('undoBtn');
            const editStatus = document.getElementById('editStatus');
            const changesCounter = document.getElementById('changesCounter');
            
            if (editMode) {
                // Save original data for cancel functionality
                originalData = JSON.parse(JSON.stringify(processedData));
                
                enableBtn.style.display = 'none';
                saveBtn.style.display = 'inline-flex';
                cancelBtn.style.display = 'inline-flex';
                if (changeHistory.length > 0) {
                    undoBtn.style.display = 'inline-flex';
                }
                editStatus.style.display = 'inline-block';
                changesCounter.style.display = 'inline-block';
                
                // Re-render table with edit capabilities
                displayResults();
                showMessage('‚úèÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß - ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'success');
            } else {
                enableBtn.style.display = 'inline-flex';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                undoBtn.style.display = 'none';
                editStatus.style.display = 'none';
                changesCounter.style.display = 'none';
                
                // Re-render table without edit capabilities
                displayResults();
            }
        }

        function saveAllChanges() {
            if (modifiedRows.size === 0) {
                showMessage('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                return;
            }
            
            // Save changes
            originalData = JSON.parse(JSON.stringify(processedData));
            modifiedRows.clear();
            changeHistory = [];
            editMode = false;
            
            // Update UI
            toggleEditMode();
            showMessage(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${modifiedRows.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function cancelAllChanges() {
            if (modifiedRows.size > 0) {
                if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${modifiedRows.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    return;
                }
            }
            
            // Restore original data
            processedData = JSON.parse(JSON.stringify(originalData));
            modifiedRows.clear();
            changeHistory = [];
            editMode = false;
            
            // Update UI
            toggleEditMode();
            showMessage('‚Ü©Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function undoLastChange() {
            if (changeHistory.length === 0) return;
            
            const lastChange = changeHistory.pop();
            const index = processedData.findIndex(item => 
                item.accountCode === lastChange.accountCode
            );
            
            if (index !== -1) {
                processedData[index] = lastChange.oldValue;
                modifiedRows.delete(index);
                displayResults();
                updateChangesCounter();
                
                if (changeHistory.length === 0) {
                    document.getElementById('undoBtn').style.display = 'none';
                }
                
                showMessage('‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'success');
            }
        }

        function updateChangesCounter() {
            const counter = document.getElementById('changesCounter');
            if (counter) {
                counter.textContent = `‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${modifiedRows.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            }
        }

        function makeEditable(cell, rowIndex, field) {
            if (!editMode) return;
            
            const currentValue = processedData[rowIndex][field];
            
            if (field === 'leadsheetGroup' || field === 'subGroup') {
                // Create select dropdown for group fields
                const select = document.createElement('select');
                select.className = 'cell-select';
                
                if (field === 'leadsheetGroup') {
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>';
                    Object.keys(leadsheetMappings).forEach(group => {
                        const option = document.createElement('option');
                        option.value = group;
                        option.textContent = group;
                        if (group === currentValue) option.selected = true;
                        select.appendChild(option);
                    });
                    
                    select.onchange = function() {
                        // Update subgroup options when group changes
                        const subGroupCell = cell.parentElement.cells[5];
                        updateSubGroupCell(subGroupCell, rowIndex, select.value);
                    };
                } else if (field === 'subGroup') {
                    const currentGroup = processedData[rowIndex].leadsheetGroup;
                    if (currentGroup && leadsheetMappings[currentGroup]) {
                        Object.keys(leadsheetMappings[currentGroup].subGroups).forEach(subGroup => {
                            const option = document.createElement('option');
                            option.value = subGroup;
                            option.textContent = subGroup;
                            if (subGroup === currentValue) option.selected = true;
                            select.appendChild(option);
                        });
                    }
                }
                
                select.onblur = function() {
                    saveCell(cell, rowIndex, field, select.value);
                };
                
                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();
            } else {
                // Create input for other fields
                const input = document.createElement('input');
                input.type = field === 'debit' || field === 'credit' ? 'number' : 'text';
                input.className = 'cell-input';
                input.value = currentValue;
                
                input.onblur = function() {
                    const newValue = field === 'debit' || field === 'credit' 
                        ? parseFloat(input.value) || 0 
                        : input.value;
                    saveCell(cell, rowIndex, field, newValue);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                };
                
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
            }
        }

        function updateSubGroupCell(cell, rowIndex, newGroup) {
            if (!newGroup || !leadsheetMappings[newGroup]) return;
            
            const select = document.createElement('select');
            select.className = 'cell-select';
            
            Object.keys(leadsheetMappings[newGroup].subGroups).forEach((subGroup, index) => {
                const option = document.createElement('option');
                option.value = subGroup;
                option.textContent = subGroup;
                if (index === 0) option.selected = true;
                select.appendChild(option);
            });
            
            select.onblur = function() {
                saveCell(cell, rowIndex, 'subGroup', select.value);
            };
            
            cell.innerHTML = '';
            cell.appendChild(select);
            
            // Auto-save the first subgroup
            processedData[rowIndex].subGroup = Object.keys(leadsheetMappings[newGroup].subGroups)[0];
        }

        function saveCell(cell, rowIndex, field, newValue) {
            const oldValue = processedData[rowIndex][field];
            
            if (oldValue !== newValue) {
                // Save to history for undo
                if (!modifiedRows.has(rowIndex)) {
                    changeHistory.push({
                        accountCode: processedData[rowIndex].accountCode,
                        oldValue: JSON.parse(JSON.stringify(processedData[rowIndex]))
                    });
                }
                
                // Update data
                processedData[rowIndex][field] = newValue;
                modifiedRows.add(rowIndex);
                
                // Update UI
                cell.parentElement.classList.add('modified-row');
                updateChangesCounter();
                
                // Show undo button
                document.getElementById('undoBtn').style.display = 'inline-flex';
            }
            
            // Restore cell display
            if (field === 'debit' || field === 'credit') {
                cell.innerHTML = newValue.toLocaleString('th-TH', {minimumFractionDigits: 2});
            } else {
                cell.innerHTML = newValue;
            }
            
            if (editMode) {
                cell.innerHTML += '<span class="edit-indicator">‚úèÔ∏è</span>';
            }
        }

        function deleteRow(rowIndex) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
            
            // Save to history
            changeHistory.push({
                action: 'delete',
                data: JSON.parse(JSON.stringify(processedData[rowIndex])),
                index: rowIndex
            });
            
            // Remove from data
            processedData.splice(rowIndex, 1);
            
            // Update display
            displayResults();
            updateChangesCounter();
            showMessage('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function loadSavedMappings() {
            const saved = localStorage.getItem('leadsheetMappings');
            if (saved) {
                savedMappings = JSON.parse(saved);
                displaySavedMappings();
            }
        }

        function displaySavedMappings() {
            const listDiv = document.getElementById('savedMappingsList');
            
            if (savedMappings.length === 0) {
                listDiv.innerHTML = '<p style="opacity: 0.9;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Mapping ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
                return;
            }
            
            listDiv.innerHTML = savedMappings.map((mapping, index) => `
                <div class="mapping-item">
                    <div class="mapping-item-info">
                        <div class="mapping-item-name">${mapping.name}</div>
                        <div class="mapping-item-details">
                            ${mapping.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'} | 
                            ${Object.keys(mapping.mappings).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | 
                            ${new Date(mapping.savedAt).toLocaleDateString('th-TH')}
                        </div>
                    </div>
                    <div class="mapping-item-actions">
                        <button onclick="loadMapping(${index})" class="mapping-action-btn mapping-load-btn">
                            ‡πÇ‡∏´‡∏•‡∏î
                        </button>
                        <button onclick="deleteMapping(${index})" class="mapping-action-btn mapping-delete-btn">
                            ‡∏•‡∏ö
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function saveCurrentMapping() {
            // Collect current custom mappings
            const currentMappings = {};
            
            processedData.forEach(item => {
                // Save mapping for each unique account name
                const key = item.accountName.toLowerCase();
                if (!currentMappings[key]) {
                    currentMappings[key] = {
                        leadsheetGroup: item.leadsheetGroup,
                        subGroup: item.subGroup,
                        accountCode: item.accountCode
                    };
                }
            });
            
            // Show modal
            document.getElementById('saveMappingModal').style.display = 'block';
            customMappings = currentMappings;
        }

        function closeSaveModal() {
            document.getElementById('saveMappingModal').style.display = 'none';
            document.getElementById('mappingNameInput').value = '';
            document.getElementById('mappingDescInput').value = '';
        }

        function confirmSaveMapping() {
            const name = document.getElementById('mappingNameInput').value.trim();
            const description = document.getElementById('mappingDescInput').value.trim();
            
            if (!name) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ Mapping');
                return;
            }
            
            const mappingData = {
                name: name,
                description: description,
                mappings: customMappings,
                savedAt: new Date().toISOString()
            };
            
            savedMappings.push(mappingData);
            localStorage.setItem('leadsheetMappings', JSON.stringify(savedMappings));
            
            displaySavedMappings();
            closeSaveModal();
            showMessage('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Mapping ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function loadMapping(index) {
            const mapping = savedMappings[index];
            if (!mapping) return;
            
            // Apply the mapping to current data
            processedData.forEach(item => {
                const key = item.accountName.toLowerCase();
                if (mapping.mappings[key]) {
                    item.leadsheetGroup = mapping.mappings[key].leadsheetGroup;
                    item.subGroup = mapping.mappings[key].subGroup;
                }
            });
            
            // Clear unclassified accounts
            unclassifiedAccounts = [];
            
            // Refresh display
            displayResults();
            showMessage(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î Mapping "${mapping.name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        function deleteMapping(index) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö Mapping ‡∏ô‡∏µ‡πâ?')) {
                savedMappings.splice(index, 1);
                localStorage.setItem('leadsheetMappings', JSON.stringify(savedMappings));
                displaySavedMappings();
                showMessage('‚úÖ ‡∏•‡∏ö Mapping ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        function exportAllMappings() {
            if (savedMappings.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ Mapping ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }
            
            const dataStr = JSON.stringify(savedMappings, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `leadsheet_mappings_${new Date().getTime()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function importMapping(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Validate the structure
                    if (!Array.isArray(imported)) {
                        throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    }
                    
                    // Merge with existing mappings
                    imported.forEach(mapping => {
                        // Check if mapping with same name exists
                        const existingIndex = savedMappings.findIndex(m => m.name === mapping.name);
                        if (existingIndex >= 0) {
                            if (confirm(`Mapping "${mapping.name}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                                savedMappings[existingIndex] = mapping;
                            }
                        } else {
                            savedMappings.push(mapping);
                        }
                    });
                    
                    localStorage.setItem('leadsheetMappings', JSON.stringify(savedMappings));
                    displaySavedMappings();
                    showMessage('‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Mapping ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    
                } catch (error) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllMappings() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö Mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
                savedMappings = [];
                localStorage.removeItem('leadsheetMappings');
                displaySavedMappings();
                showMessage('‚úÖ ‡∏•‡∏ö Mapping ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // Also update the applyManualClassification function to support auto-learning
        function applyManualClassification() {
            const accountCode = document.getElementById('manualAccountSelect').value;
            const group = document.getElementById('manualGroupSelect').value;
            const subGroup = document.getElementById('manualSubGroupSelect').value;
            
            if (!accountCode || !group || !subGroup) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            // Update the classification
            const index = processedData.findIndex(item => item.accountCode === accountCode);
            if (index !== -1) {
                processedData[index].leadsheetGroup = group;
                processedData[index].subGroup = subGroup;
                
                // Auto-learn: save this mapping for future use
                const accountName = processedData[index].accountName.toLowerCase();
                if (!customMappings[accountName]) {
                    customMappings[accountName] = {
                        leadsheetGroup: group,
                        subGroup: subGroup
                    };
                }
                
                // Update unclassified list
                unclassifiedAccounts = processedData.filter(item => 
                    item.leadsheetGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' || item.subGroup === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
                );
                
                // Refresh display
                displayResults();
                
                // Show success message
                showMessage('‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        // Update applyAllSuggestions to also save to customMappings
        function applyAllSuggestions() {
            Object.keys(aiSuggestions).forEach(accountCode => {
                const suggestion = aiSuggestions[accountCode];
                const index = processedData.findIndex(item => item.accountCode === accountCode);
                
                if (index !== -1) {
                    processedData[index].leadsheetGroup = suggestion.group;
                    processedData[index].subGroup = suggestion.subGroup;
                    
                    // Auto-learn: save this mapping
                    const accountName = processedData[index].accountName.toLowerCase();
                    if (!customMappings[accountName]) {
                        customMappings[accountName] = {
                            leadsheetGroup: suggestion.group,
                            subGroup: suggestion.subGroup
                        };
                    }
                }
            });
            
            // Clear unclassified accounts
            unclassifiedAccounts = [];
            aiSuggestions = {};
            
            // Refresh display
            displayResults();
            
            // Show success message
            showMessage('‚úÖ ‡∏ô‡∏≥‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        // Modal close on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('saveMappingModal');
            if (event.target == modal) {
                closeSaveModal();
            }
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('processBtn').disabled = false;
                const label = document.querySelector('.file-input-label');
                label.textContent = `‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß: ${file.name}`;
            }
        });

        document.getElementById('processBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const reader = new FileReader();
            const fileName = file.name.toLowerCase();

            if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                reader.onload = function(e) {
                    const text = e.target.result;
                    parseCSV(text);
                };
                reader.readAsText(file, 'UTF-8');
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    parseExcel(jsonData);
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function parseCSV(text) {
            Papa.parse(text, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    uploadedData = results.data;
                    processData();
                }
            });
        }

        function parseExcel(data) {
            if (data.length < 2) {
                alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                return;
            }

            const headers = data[0];
            uploadedData = [];

            for (let i = 1; i < data.length; i++) {
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = data[i][index] || '';
                });
                uploadedData.push(row);
            }

            processData();
        }

        function generateAccountCode(accountName, leadsheetGroup, subGroup) {
            // First, check if there's a predefined code for this subgroup
            const normalizedName = accountName.toLowerCase();
            
            // Search in accountCodeMapping
            for (const [key, code] of Object.entries(accountCodeMapping)) {
                if (normalizedName.includes(key.toLowerCase()) || subGroup === key) {
                    return code;
                }
            }
            
            // If no exact match, generate based on account type
            let prefix = '9'; // Default for uncategorized
            
            // Determine prefix based on leadsheet group
            if (leadsheetGroup.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') || leadsheetGroup.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏á‡∏ó‡∏∏‡∏ô') || 
                leadsheetGroup.includes('‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ') || leadsheetGroup.includes('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') || 
                leadsheetGroup.includes('‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå') || leadsheetGroup.includes('‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô')) {
                prefix = '1'; // Assets
            } else if (leadsheetGroup.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') || leadsheetGroup.includes('‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô') || 
                       leadsheetGroup.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ') || leadsheetGroup.includes('‡∏†‡∏≤‡∏©‡∏µ')) {
                prefix = '2'; // Liabilities
            } else if (leadsheetGroup.includes('‡∏ó‡∏∏‡∏ô') || leadsheetGroup.includes('‡∏´‡∏∏‡πâ‡∏ô') || 
                       leadsheetGroup.includes('‡∏Å‡∏≥‡πÑ‡∏£') || leadsheetGroup.includes('‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô')) {
                prefix = '3'; // Equity
            } else if (leadsheetGroup.includes('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ')) {
                prefix = '4'; // Revenue
            } else if (leadsheetGroup.includes('‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô') || leadsheetGroup.includes('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢') || 
                       leadsheetGroup.includes('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô') || leadsheetGroup.includes('‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ')) {
                prefix = '5'; // Expenses
            }
            
            // Generate unique code - ensure codeCounters[prefix] exists and is a valid number
            if (!codeCounters[prefix] || isNaN(codeCounters[prefix])) {
                codeCounters[prefix] = prefix === '1' ? 1800 : 
                                       prefix === '2' ? 2700 : 
                                       prefix === '3' ? 3500 : 
                                       prefix === '4' ? 4500 : 
                                       prefix === '5' ? 5800 : 9000;
            }
            
            codeCounters[prefix]++;
            return prefix + String(codeCounters[prefix]).padStart(3, '0');
        }

        function detectAccountType(accountCode, accountName) {
            // Normalize the input
            const code = String(accountCode || '').toLowerCase();
            const name = String(accountName || '').toLowerCase();
            
            // Check if already classified in customMappings
            if (customMappings[name]) {
                return {
                    leadsheetGroup: customMappings[name].leadsheetGroup,
                    subGroup: customMappings[name].subGroup
                };
            }
            
            // Find best matching leadsheet group
            for (const [groupName, groupData] of Object.entries(leadsheetMappings)) {
                // Check keywords
                for (const keyword of groupData.keywords) {
                    if (name.includes(keyword.toLowerCase()) || code.includes(keyword.toLowerCase())) {
                        // Find best matching subgroup
                        for (const [subGroupName, subKeywords] of Object.entries(groupData.subGroups)) {
                            for (const subKeyword of subKeywords) {
                                if (name.includes(subKeyword.toLowerCase())) {
                                    return {
                                        leadsheetGroup: groupName,
                                        subGroup: subGroupName
                                    };
                                }
                            }
                        }
                        // If no subgroup matched, return the first one as default
                        const defaultSubGroup = Object.keys(groupData.subGroups)[0];
                        return {
                            leadsheetGroup: groupName,
                            subGroup: defaultSubGroup
                        };
                    }
                }
            }

            // Default categorization based on account code patterns
            if (code.startsWith('1')) {
                return { leadsheetGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô', subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ' };
            } else if (code.startsWith('2')) {
                return { leadsheetGroup: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô', subGroup: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ' };
            } else if (code.startsWith('3')) {
                return { leadsheetGroup: '‡∏ó‡∏∏‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß', subGroup: '‡∏´‡∏∏‡πâ‡∏ô‡∏™‡∏≤‡∏°‡∏±‡∏ç' };
            } else if (code.startsWith('4')) {
                return { leadsheetGroup: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô', subGroup: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô' };
            } else if (code.startsWith('5')) {
                return { leadsheetGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô' };
            }

            return { leadsheetGroup: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', subGroup: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' };
        }

        function processData() {
            processedData = [];
            unclassifiedAccounts = [];
            
            // Get column names (handle various formats)
            const possibleCodeColumns = ['‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏£‡∏´‡∏±‡∏™', 'Account Code', 'Code', 'account_code'];
            const possibleNameColumns = ['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', '‡∏ä‡∏∑‡πà‡∏≠', 'Account Name', 'Name', 'account_name'];
            const possibleDebitColumns = ['‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï', '‡πÄ‡∏î‡∏ö‡∏¥‡∏ï', 'Debit', 'DR', 'debit'];
            const possibleCreditColumns = ['‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', '‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï', 'Credit', 'CR', 'credit'];

            uploadedData.forEach(row => {
                // Find the actual column names
                let accountCode = '';
                let accountName = '';
                let debit = 0;
                let credit = 0;

                // Extract account code
                for (const col of possibleCodeColumns) {
                    if (row[col] !== undefined) {
                        accountCode = row[col];
                        break;
                    }
                }

                // Extract account name
                for (const col of possibleNameColumns) {
                    if (row[col] !== undefined) {
                        accountName = row[col];
                        break;
                    }
                }

                // Extract debit
                for (const col of possibleDebitColumns) {
                    if (row[col] !== undefined) {
                        debit = parseFloat(row[col]) || 0;
                        break;
                    }
                }

                // Extract credit
                for (const col of possibleCreditColumns) {
                    if (row[col] !== undefined) {
                        credit = parseFloat(row[col]) || 0;
                        break;
                    }
                }

                // If no standard columns found, try to use first 4 columns
                if (!accountCode && !accountName) {
                    const keys = Object.keys(row);
                    if (keys.length >= 2) {
                        accountCode = row[keys[0]] || '';
                        accountName = row[keys[1]] || '';
                        if (keys.length >= 3) debit = parseFloat(row[keys[2]]) || 0;
                        if (keys.length >= 4) credit = parseFloat(row[keys[3]]) || 0;
                    }
                }

                if (accountCode || accountName) {
                    const classification = detectAccountType(accountCode, accountName);
                    
                    // Generate account code if missing
                    let finalAccountCode = accountCode;
                    if (!accountCode || accountCode === '') {
                        finalAccountCode = generateAccountCode(accountName, classification.leadsheetGroup, classification.subGroup);
                    }
                    
                    const processedItem = {
                        accountCode: finalAccountCode,
                        accountName: accountName,
                        leadsheetGroup: classification.leadsheetGroup,
                        subGroup: classification.subGroup,
                        debit: debit,
                        credit: credit
                    };
                    
                    processedData.push(processedItem);
                    
                    // Track unclassified accounts
                    if (classification.leadsheetGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' || classification.subGroup === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                        unclassifiedAccounts.push(processedItem);
                    }
                }
            });

            displayResults();
        }

        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const tableBody = document.getElementById('tableBody');
            const statsCards = document.getElementById('statsCards');
            const aiHelperSection = document.getElementById('aiHelperSection');

            // Clear previous results
            tableBody.innerHTML = '';
            statsCards.innerHTML = '';

            // Calculate statistics
            const groupCounts = {};
            let totalDebit = 0;
            let totalCredit = 0;

            processedData.forEach(item => {
                groupCounts[item.leadsheetGroup] = (groupCounts[item.leadsheetGroup] || 0) + 1;
                totalDebit += item.debit;
                totalCredit += item.credit;
            });

            // Display statistics
            statsCards.innerHTML = `
                <div class="stat-card">
                    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                    <div class="number">${processedData.length}</div>
                </div>
                <div class="stat-card">
                    <h4>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° Leadsheet</h4>
                    <div class="number">${Object.keys(groupCounts).length}</div>
                </div>
                <div class="stat-card">
                    <h4>‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï‡∏£‡∏ß‡∏°</h4>
                    <div class="number">${totalDebit.toLocaleString('th-TH', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <h4>‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏£‡∏ß‡∏°</h4>
                    <div class="number">${totalCredit.toLocaleString('th-TH', {minimumFractionDigits: 2})}</div>
                </div>
            `;

            // Display table data
            processedData.forEach((item, index) => {
                const row = document.createElement('tr');
                
                // Add modified-row class if this row was edited
                if (modifiedRows.has(index)) {
                    row.classList.add('modified-row');
                }
                
                // Highlight unclassified accounts
                if (item.leadsheetGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' || item.subGroup === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    row.style.backgroundColor = '#fff3cd';
                }
                
                // Action buttons column
                let actionCell = '<td>';
                if (editMode) {
                    actionCell += `
                        <div class="action-buttons">
                            <button onclick="deleteRow(${index})" class="delete-row-btn" title="‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">üóëÔ∏è</button>
                        </div>
                    `;
                } else {
                    actionCell += '-';
                }
                actionCell += '</td>';
                
                row.innerHTML = actionCell + `
                    <td class="${editMode ? 'editable-cell' : ''}" onclick="${editMode ? `makeEditable(this, ${index}, 'accountCode')` : ''}">
                        ${item.accountCode}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="${editMode ? 'editable-cell' : ''}" onclick="${editMode ? `makeEditable(this, ${index}, 'accountName')` : ''}">
                        ${item.accountName}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="${editMode ? 'editable-cell' : ''}" onclick="${editMode ? `makeEditable(this, ${index}, 'leadsheetGroup')` : ''}">
                        ${item.leadsheetGroup}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="${editMode ? 'editable-cell' : ''}" onclick="${editMode ? `makeEditable(this, ${index}, 'subGroup')` : ''}">
                        ${item.subGroup}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="${editMode ? 'editable-cell' : ''}" style="text-align: right;" onclick="${editMode ? `makeEditable(this, ${index}, 'debit')` : ''}">
                        ${item.debit.toLocaleString('th-TH', {minimumFractionDigits: 2})}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                    <td class="${editMode ? 'editable-cell' : ''}" style="text-align: right;" onclick="${editMode ? `makeEditable(this, ${index}, 'credit')` : ''}">
                        ${item.credit.toLocaleString('th-TH', {minimumFractionDigits: 2})}
                        ${editMode ? '<span class="edit-indicator">‚úèÔ∏è</span>' : ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update unclassified accounts list
            unclassifiedAccounts = processedData.filter(item => 
                item.leadsheetGroup === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' || item.subGroup === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            );

            // Show AI helper if there are unclassified accounts
            if (unclassifiedAccounts.length > 0) {
                aiHelperSection.style.display = 'block';
                displayUnclassifiedAccounts();
                setupManualClassification();
            } else {
                aiHelperSection.style.display = 'none';
            }

            // Update AI Copilot status
            updateCopilotStatus();

            // Show results section
            resultsSection.classList.add('active');
        }

        function displayUnclassifiedAccounts() {
            const unclassifiedList = document.getElementById('unclassifiedList');
            unclassifiedList.innerHTML = `
                <p style="margin-bottom: 10px;">‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ ${unclassifiedAccounts.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</p>
                ${unclassifiedAccounts.map(acc => `
                    <div class="unclassified-item">
                        <span>${acc.accountCode} - ${acc.accountName}</span>
                        <span>${(acc.debit - acc.credit).toLocaleString('th-TH', {minimumFractionDigits: 2})}</span>
                    </div>
                `).join('')}
            `;
        }

        function setupManualClassification() {
            const accountSelect = document.getElementById('manualAccountSelect');
            const groupSelect = document.getElementById('manualGroupSelect');
            
            // Populate account select
            accountSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ --</option>';
            unclassifiedAccounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.accountCode;
                option.textContent = `${acc.accountCode} - ${acc.accountName}`;
                accountSelect.appendChild(option);
            });
            
            // Populate group select
            groupSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>';
            Object.keys(leadsheetMappings).forEach(group => {
                const option = document.createElement('option');
                option.value = group;
                option.textContent = group;
                groupSelect.appendChild(option);
            });
        }

        function updateSubGroupOptions() {
            const groupSelect = document.getElementById('manualGroupSelect');
            const subGroupSelect = document.getElementById('manualSubGroupSelect');
            const selectedGroup = groupSelect.value;
            
            subGroupSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢ --</option>';
            
            if (selectedGroup && leadsheetMappings[selectedGroup]) {
                Object.keys(leadsheetMappings[selectedGroup].subGroups).forEach(subGroup => {
                    const option = document.createElement('option');
                    option.value = subGroup;
                    option.textContent = subGroup;
                    subGroupSelect.appendChild(option);
                });
            }
        }

        function applyManualClassification() {
            const accountCode = document.getElementById('manualAccountSelect').value;
            const group = document.getElementById('manualGroupSelect').value;
            const subGroup = document.getElementById('manualSubGroupSelect').value;
            
            if (!accountCode || !group || !subGroup) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            // Update the classification
            const index = processedData.findIndex(item => item.accountCode === accountCode);
            if (index !== -1) {
                processedData[index].leadsheetGroup = group;
                processedData[index].subGroup = subGroup;
                
                // Remove from unclassified
                unclassifiedAccounts = unclassifiedAccounts.filter(acc => acc.accountCode !== accountCode);
                
                // Refresh display
                displayResults();
                
                // Show success message
                showMessage('‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        }

        function getAISuggestions() {
            const aiSuggestBtn = document.getElementById('aiSuggestBtn');
            const aiSuggestionResult = document.getElementById('aiSuggestionResult');
            
            aiSuggestBtn.disabled = true;
            aiSuggestBtn.classList.add('loading');
            aiSuggestBtn.innerHTML = '<span>‚è≥</span><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</span>';
            
            // Simulate AI analysis (in real implementation, this would call an API)
            setTimeout(() => {
                const suggestions = analyzeWithAI(unclassifiedAccounts);
                displayAISuggestions(suggestions);
                
                aiSuggestBtn.disabled = false;
                aiSuggestBtn.classList.remove('loading');
                aiSuggestBtn.innerHTML = '<span>‚ú®</span><span>‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</span>';
                aiSuggestionResult.style.display = 'block';
            }, 2000);
        }

        function analyzeWithAI(accounts) {
            const suggestions = {};
            
            accounts.forEach(acc => {
                const name = acc.accountName.toLowerCase();
                const code = acc.accountCode;
                
                // AI-like pattern matching with more sophisticated rules
                if (name.includes('‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô') || name.includes('‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô') || name.includes('insurance')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
                        confidence: 85
                    };
                } else if (name.includes('‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') || name.includes('‡∏†‡∏≤‡∏©‡∏µ‡∏Ç‡∏≤‡∏¢')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏†‡∏≤‡∏©‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢',
                        confidence: 90
                    };
                } else if (name.includes('‡∏†‡∏≤‡∏©‡∏µ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ') || name.includes('‡∏†‡∏≤‡∏©‡∏µ‡∏ã‡∏∑‡πâ‡∏≠')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                        confidence: 85
                    };
                } else if (name.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô') || name.includes('deposit')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÑ‡∏°‡πà‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß',
                        confidence: 80
                    };
                } else if (name.includes('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ') && name.includes('‡∏£‡∏±‡∏ö‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                        confidence: 90
                    };
                } else if (name.includes('‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤') || name.includes('rent')) {
                    if (acc.debit > 0) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                            subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
                            confidence: 85
                        };
                    } else {
                        suggestions[acc.accountCode] = {
                            group: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                            subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢',
                            confidence: 80
                        };
                    }
                } else if (name.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                        confidence: 75
                    };
                } else if (name.includes('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')) {
                    if (acc.debit > 0) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢',
                            subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                            confidence: 70
                        };
                    } else {
                        suggestions[acc.accountCode] = {
                            group: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                            subGroup: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                            confidence: 70
                        };
                    }
                } else if (name.includes('‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢')) {
                    if (acc.debit > 0) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',
                            subGroup: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô',
                            confidence: 80
                        };
                    } else {
                        suggestions[acc.accountCode] = {
                            group: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô',
                            subGroup: '‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å',
                            confidence: 80
                        };
                    }
                } else if (name.includes('‡∏†‡∏≤‡∏©‡∏µ') && !name.includes('‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ')) {
                    suggestions[acc.accountCode] = {
                        group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                        subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                        confidence: 70
                    };
                } else {
                    // Default suggestion based on account code pattern
                    if (code.startsWith('1')) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                            subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                            confidence: 60
                        };
                    } else if (code.startsWith('2')) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                            subGroup: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                            confidence: 60
                        };
                    } else if (code.startsWith('4')) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                            subGroup: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                            confidence: 65
                        };
                    } else if (code.startsWith('5')) {
                        suggestions[acc.accountCode] = {
                            group: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                            subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô',
                            confidence: 65
                        };
                    } else if (code.startsWith('9')) {
                        // For accounts starting with 9, try to classify based on name patterns
                        if (name.includes('‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå') || name.includes('‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ')) {
                            suggestions[acc.accountCode] = {
                                group: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                                subGroup: '‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÜ',
                                confidence: 70
                            };
                        } else if (name.includes('‡∏´‡∏ô‡∏µ‡πâ') || name.includes('‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡∏µ‡πâ') || name.includes('‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢')) {
                            suggestions[acc.accountCode] = {
                                group: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô',
                                subGroup: '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                                confidence: 70
                            };
                        } else if (acc.debit > 0) {
                            suggestions[acc.accountCode] = {
                                group: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                                subGroup: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô',
                                confidence: 60
                            };
                        } else if (acc.credit > 0) {
                            suggestions[acc.accountCode] = {
                                group: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                                subGroup: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô',
                                confidence: 60
                            };
                        }
                    }
                }
            });
            
            aiSuggestions = suggestions;
            return suggestions;
        }

        function displayAISuggestions(suggestions) {
            const resultDiv = document.getElementById('aiSuggestionResult');
            
            if (Object.keys(suggestions).length === 0) {
                resultDiv.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>';
                return;
            }
            
            let html = '<h4>üìä ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI:</h4>';
            html += '<div style="margin: 15px 0;">';
            
            unclassifiedAccounts.forEach(acc => {
                const suggestion = suggestions[acc.accountCode];
                if (suggestion) {
                    html += `
                        <div class="suggestion-item">
                            <div><strong>${acc.accountCode}</strong> - ${acc.accountName}</div>
                            <div>${suggestion.group}</div>
                            <div>${suggestion.subGroup}</div>
                            <div style="text-align: center;">
                                <span style="color: ${suggestion.confidence > 80 ? '#28a745' : suggestion.confidence > 60 ? '#ffc107' : '#dc3545'};">
                                    ${suggestion.confidence}%
                                </span>
                            </div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            html += '<button onclick="applyAllSuggestions()" class="apply-suggestions-btn">‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>';
            
            resultDiv.innerHTML = html;
        }

        function applyAllSuggestions() {
            Object.keys(aiSuggestions).forEach(accountCode => {
                const suggestion = aiSuggestions[accountCode];
                const index = processedData.findIndex(item => item.accountCode === accountCode);
                
                if (index !== -1) {
                    processedData[index].leadsheetGroup = suggestion.group;
                    processedData[index].subGroup = suggestion.subGroup;
                }
            });
            
            // Clear unclassified accounts
            unclassifiedAccounts = [];
            aiSuggestions = {};
            
            // Refresh display
            displayResults();
            
            // Show success message
            showMessage('‚úÖ ‡∏ô‡∏≥‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.minWidth = '300px';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 500);
            }, 3000);
        }

        function forceRefreshTable() {
            // Force complete refresh of the table
            displayResults();
            
            // Show loading animation
            const tables = document.getElementById('resultsTable');
            tables.style.opacity = '0.5';
            
            setTimeout(() => {
                tables.style.opacity = '1';
                showMessage('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }, 300);
        }

        function downloadCSV() {
            const csv = Papa.unparse(processedData);
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'leadsheet_grouped_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadExcel() {
            const ws = XLSX.utils.json_to_sheet(processedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Leadsheet Groups');
            XLSX.writeFile(wb, 'leadsheet_grouped_' + new Date().getTime() + '.xlsx');
        }
    </script>
</body>
</html>